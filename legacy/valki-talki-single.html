<!-- =========================================================
     VALKI TALKI â€” SINGLE-FILE WIDGET (BUBBLE LAUNCHER EDITION)
     - No landing input field
     - Floating chat bubble launcher (badge/unread)
     - Fullscreen chat modal (100dvh + safe-area)
     - JPEG/PNG upload (up to 4, 5MB each) + thumbnail tray + remove
     - Composer auto-grow (up to 4 lines)
     - Keeps OAuth / guest / import / delete flows intact
========================================================= -->

<style>
/* =========================================================
   VALKI â€” Theme + Layout Locks
========================================================= */
#valki-root{
  /* Theme */
  --bg: #0b0b0b;
  --surface: rgba(255,255,255,.04);
  --surface-2: rgba(255,255,255,.06);
  --border: rgba(255,255,255,.10);
  --border-2: rgba(255,255,255,.16);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.60);
  --muted-2: rgba(255,255,255,.45);

  --brand: #f15a24;
  --brand-2: #ff7a45;
  --ring: rgba(241,90,36,.22);

  --btn-fill: #e7e7e7;
  --btn-text: #0b0b0b;

  /* HARD layout lock (ChatGPT feel) */
  --col: 760px;
  --gutter: 24px;

  --radius: 14px;
  --radius-pill: 999px;

  --shadow-1: 0 12px 40px rgba(0,0,0,.55);
  --shadow-2: 0 20px 70px rgba(0,0,0,.70);

  --font: system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;

  --valki-vh: 1vh;
  --vvh: calc(var(--valki-vh, 1vh) * 100);

  /* (Fallback) composer height â€“ als je later JS toevoegt kan dit dynamisch */
  --composer-h: 110px;

  --valki-chat-pad-bottom: calc(env(safe-area-inset-bottom) + 10px);

  /* Background + vignette + blur */
  --chat-bg-image: url("https://valki.wiki/onewebmedia/20250814_1313_Eagle%20in%20Amsterdam_remix_01k2m4cnjnf508h5mxsej89c1m.png");
  --chat-bg-color: #070707;

  --vignette-strength: .58;  /* iets steviger voor blok-contrast */
  --side-blur: 30px;
  --side-tint: rgba(0,0,0,.18); /* transparanter zodat bg sterker doorkomt */

  /* Chat block */
  --chat-block-bg: rgba(8,8,8,.78);           /* â€œmassief blokâ€ */
  --chat-block-border: rgba(255,255,255,.10);
  --chat-block-blur: 10px;
}

#valki-root, #valki-root *{ box-sizing:border-box; }

#valki-root button,
#valki-root input,
#valki-root textarea{
  all: unset;
  box-sizing:border-box;
  font: inherit;
  color: inherit;
}

#valki-root button{ cursor:pointer; }
#valki-root input, #valki-root textarea{ cursor:text; }

/* Focus ring alleen voor knoppen (keyboard users) */
#valki-root button:focus-visible{
  outline: 1px solid var(--brand);
  outline-offset: 1px;
}

/* Geen oranje outline op input/textarea */
#valki-root input:focus-visible,
#valki-root textarea:focus-visible{
  outline: none !important;
}

#valki-root ::selection{ background: rgba(140,170,255,.14); }
#valki-root ::-moz-selection{ background: rgba(140,170,255,.14); }

@supports (-webkit-touch-callout: none){
  #valki-root input, #valki-root textarea{ font-size:16px; }
}

/* Hide background when modal is open to avoid double-blur look */
html.valki-chat-open #valki-root #valki-bg{
  display:none !important;
}

/* =========================================================
   Root container
========================================================= */
#valki-root{
  position:relative;
  z-index:1;
  min-height:var(--vvh);
  width:100%;
  margin:0;
  padding: env(safe-area-inset-top) 0 0;
  background: transparent;
  color: var(--text);
  font-family: var(--font);
}

/* =========================================================
   Floating Chat Bubble Launcher (Beautiful)
========================================================= */
#valki-root .valki-bubble{
  position: fixed;
  right: 18px;
  bottom: calc(18px + env(safe-area-inset-bottom));
  width: 64px;
  height: 64px;
  border-radius: 999px;

  /* Subtle gradient + inner ring */
  background:
    radial-gradient(140% 140% at 30% 25%, rgba(255,255,255,.28), rgba(255,255,255,0) 45%),
    linear-gradient(145deg, var(--brand-2), var(--brand));
  box-shadow:
    0 26px 70px rgba(0,0,0,.62),
    0 0 0 1px rgba(255,255,255,.18) inset,
    0 8px 24px rgba(241,90,36,.22);

  display:flex;
  align-items:center;
  justify-content:center;

  z-index: 2147482998;
  transform: translateZ(0);
  transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
}

#valki-root .valki-bubble:hover{
  transform: translateY(-2px);
  filter: brightness(1.04);
  box-shadow:
    0 30px 85px rgba(0,0,0,.68),
    0 0 0 1px rgba(255,255,255,.22) inset,
    0 10px 32px rgba(241,90,36,.26);
}

#valki-root .valki-bubble:active{
  transform: translateY(0px) scale(.99);
}

#valki-root .valki-bubble-icon{
  width: 28px;
  height: 28px;
  color: rgba(255,255,255,.96);
  filter: drop-shadow(0 8px 12px rgba(0,0,0,.35));
}

#valki-root .valki-bubble-badge{
  position:absolute;
  top: 10px;
  right: 10px;
  min-width: 18px;
  height: 18px;
  padding: 0 5px;
  border-radius: 999px;
  background: #ff3b30;
  color: #fff;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: -.02em;
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 14px 26px rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.22);
}

#valki-root .valki-bubble-ping{
  position:absolute;
  inset: -6px;
  border-radius: 999px;
  border: 2px solid rgba(241,90,36,.35);
  animation: valkiPing 2.2s infinite;
  pointer-events:none;
  opacity:.8;
}

@keyframes valkiPing{
  0%{ transform: scale(.90); opacity:.45; }
  65%{ transform: scale(1.10); opacity:0; }
  100%{ transform: scale(1.10); opacity:0; }
}

/* Hide bubble while chat is open */
html.valki-chat-open #valki-root .valki-bubble{
  opacity: 0;
  pointer-events:none;
  transform: translateY(10px);
}

/* =========================================================
   Overlays / Fullscreen chat (iOS/rotate/keyboard-proof)
   - Uses your JS-driven --vvh (via --valki-vh)
========================================================= */

/* Make sure the actual overlay nodes sit above everything */
#valki-root #valki-overlay,
#valki-root #valki-auth-overlay,
#valki-root #valki-confirm-overlay,
#valki-root #valki-logout-overlay{
  z-index: 2147483000 !important;
}

/* Base overlay layout */
#valki-root .valki-overlay,
#valki-root .valki-auth-overlay,
#valki-root .valki-confirm-overlay,
#valki-root .valki-logout-overlay{
  position: fixed;
  inset: 0;

  /* IMPORTANT: var(--vvh) = calc(var(--valki-vh) * 100) */
  height: var(--vvh);
  width: 100%;

  /* default hidden state */
  display: none;
  opacity: 0;
  pointer-events: none;

  /* nice fade */
  transition: opacity .18s ease;
  isolation: isolate;

  /* your overlay dim */
  background: rgba(0,0,0,.82);

  /* flex baseline (enabled when .is-visible) */
  align-items: stretch;
  justify-content: center;
}

/* Main chat overlay fills vertically */
#valki-root .valki-overlay{
  align-items: stretch;
  justify-content: center;
}

/* Centered overlays (auth/confirm/logout) */
#valki-root .valki-auth-overlay,
#valki-root .valki-confirm-overlay,
#valki-root .valki-logout-overlay{
  align-items: center;
  justify-content: center;
}

/* Fullscreen modal follows the same vh logic */
#valki-root .valki-modal{
  height: var(--vvh);
  width: 100%;
}

/* Visible state */
#valki-root .valki-overlay.is-visible,
#valki-root .valki-auth-overlay.is-visible,
#valki-root .valki-confirm-overlay.is-visible,
#valki-root .valki-logout-overlay.is-visible{
  display: flex;
  opacity: 1;
  pointer-events: auto;
}

/* ===============================
   AUTH MODAL â€“ FIXED CARD LAYOUT
================================ */

#valki-root .valki-auth-modal{
  width: 100%;
  max-width: 420px;
  margin: 0 16px;

  background: rgba(12,12,12,.92);
  backdrop-filter: blur(18px) saturate(120%);
  -webkit-backdrop-filter: blur(18px) saturate(120%);

  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 30px 90px rgba(0,0,0,.65);

  padding: 22px 22px 20px;
  text-align: center;

  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Avatar/logo bovenin netjes klein */
#valki-root .valki-auth-avatar{
  width: 72px;
  height: 72px;
  border-radius: 50%;
  margin-bottom: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.04);
}

/* Titel */
#valki-root .valki-auth-title{
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
}

/* Subtitel */
#valki-root .valki-auth-subtitle{
  font-size: 13px;
  color: rgba(255,255,255,.65);
  margin-bottom: 18px;
}

/* Buttons stack */
#valki-root .valki-auth-buttons{
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-bottom: 14px;
}

/* Buttons */
#valki-root .valki-auth-btn{
  width: 100%;
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 14px;
}

#valki-root .valki-auth-btn.primary{
  background: #f2f2f2;
  color: #0b0b0b;
}

/* Footer tekst */
#valki-root .valki-auth-note{
  font-size: 11px;
  color: rgba(255,255,255,.55);
  margin-bottom: 8px;
}

/* Dismiss */
#valki-root .valki-auth-dismiss{
  font-size: 12px;
  color: rgba(255,255,255,.7);
  cursor: pointer;
}

/* ===============================
   AUTH BUTTON HOVER â€“ FIXED
================================ */

#valki-root .valki-auth-btn{
  cursor: pointer;
  transition:
    transform .12s ease,
    box-shadow .12s ease,
    border-color .12s ease,
    background .12s ease,
    filter .12s ease;
}

/* ---------- DEFAULT (dark buttons) ---------- */
@media (hover:hover){
  #valki-root .valki-auth-btn:not(.primary):hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,.09);
    border-color: rgba(255,255,255,.22);
    box-shadow: 0 14px 34px rgba(0,0,0,.35);
  }
}

/* ---------- PRIMARY (white button) ---------- */
@media (hover:hover){
  #valki-root .valki-auth-btn.primary:hover{
    transform: translateY(-1px);
    background: #f2f2f2;              /* blijft wit */
    border-color: rgba(0,0,0,.08);
    box-shadow: 0 18px 44px rgba(0,0,0,.38);
    filter: brightness(1.01);         /* subtiel, geen grijs */
  }
}

/* Pressed */
#valki-root .valki-auth-btn:active{
  transform: translateY(0) scale(.99);
}

/* Keyboard focus */
#valki-root .valki-auth-btn:focus-visible{
  outline: none;
  box-shadow:
    0 0 0 2px var(--ring),
    0 18px 44px rgba(0,0,0,.38);
}

/* =========================================================
   Modal + Background + Vignette + Side Blur  (FIX)
========================================================= */
#valki-root .valki-modal{
  width:100vw;
  height:100vh;
  height:100dvh;

  /* IMPORTANT: use your background image variable */
  background:
    var(--chat-bg-image) center / cover no-repeat,
    linear-gradient(#0c0c0c,#070707);
  background-color: var(--chat-bg-color);

  border-radius:0;
  overflow:hidden;
  display:flex;
  flex-direction:column;

  position: relative;
  isolation: isolate;

  /* Outer â€œblock presenceâ€ */
  box-shadow:
    0 0 0 1px rgba(255,255,255,.04),
    0 30px 80px rgba(0,0,0,.65);
}

/* =========================================================
   VIGNETTE + SIDE BLUR OUTSIDE CHAT BLOCK (REPLACES OLD ::before/::after)
========================================================= */

/* Put vignette inside modal background layers */
#valki-root .valki-modal{
  background:
    /* Vignette */
    radial-gradient(
      120% 100% at 50% 45%,
      rgba(0,0,0,0) 0%,
      rgba(0,0,0,0) 42%,
      rgba(0,0,0, calc(var(--vignette-strength, .58) * .42)) 68%,
      rgba(0,0,0, var(--vignette-strength, .58)) 100%
    ),
    /* Your background image */
    var(--chat-bg-image) center / cover no-repeat,
    /* Fallback */
    linear-gradient(#0c0c0c,#070707);

  background-color: var(--chat-bg-color, #070707);

  position: relative;
  isolation: isolate;

  /* Calculate chat block width (col + 2*gutter) */
  --chat-block-w: min(100vw, calc(var(--col) + (var(--gutter) * 2)));
  --side-w: max(0px, calc((100vw - var(--chat-block-w)) / 2));
}

/* LEFT side blur panel */
#valki-root .valki-modal::before{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  left:0;
  width: var(--side-w);
  z-index:1;
  pointer-events:none;

  background: rgba(0,0,0,.18); /* transparant maar definieert de blur-zone */
  backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);
  -webkit-backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);

  box-shadow: inset -1px 0 rgba(255,255,255,.06);
}

/* RIGHT side blur panel */
#valki-root .valki-modal::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  right:0;
  width: var(--side-w);
  z-index:1;
  pointer-events:none;

  background: rgba(0,0,0,.18);
  backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);
  -webkit-backdrop-filter: blur(var(--side-blur, 18px)) saturate(115%);

  box-shadow: inset 1px 0 rgba(255,255,255,.06);
}

/* Keep real UI above blur panels */
#valki-root .valki-modal > *{
  position: relative;
  z-index: 2;
}

/* Mobile: disable side blur panels */
@media (max-width: 640px){
  #valki-root .valki-modal::before,
  #valki-root .valki-modal::after{
    display:none;
  }
}

/* Ensure actual UI sits above overlays */
#valki-root .valki-modal > *{
  position: relative;
  z-index: 2;
}

/* =========================================================
   Header â€” HARD column lock
========================================================= */
#valki-root .valki-modal-header{
  padding: calc(10px + env(safe-area-inset-top)) var(--gutter) 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);

  /* Let block styling control background */
  background: transparent;
  backdrop-filter: none;
}

#valki-root .valki-modal-header-inner{
  max-width: var(--col) !important;
  width: 100% !important;
  margin: 0 auto !important;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

#valki-root .valki-header-left{ display:flex; align-items:center; gap: 10px; min-width:0; }

#valki-root .valki-header-avatar{
  width:30px;height:30px;border-radius:50%;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.05);
  flex:0 0 auto;
}

#valki-root .valki-modal-title-text{ display:flex; flex-direction:column; min-width:0; }
#valki-root .valki-modal-title-text .name{
  font-size: 14px;
  font-weight: 720;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#valki-root .valki-modal-title-text .session{
  font-size: 11px;
  color: var(--muted-2);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

#valki-root .valki-header-actions{ display:flex; align-items:center; gap: 8px; }

#valki-root .valki-pill{
  padding: 7px 10px;
  border-radius: var(--radius-pill);
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.10);
  font-size: 12px;
  color: rgba(255,255,255,.86);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
#valki-root .valki-pill:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.06);
  border-color: rgba(255,255,255,.16);
}
#valki-root .valki-pill.primary{
  background: #f2f2f2;
  border-color: rgba(255,255,255,.20);
  color: #101010;
}
#valki-root .valki-close-btn{
  width:30px;height:30px;
  border-radius:50%;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
}

/* =========================================================
   STRONG CHAT BLOCK (FINAL)
   - Makes header/messages/composer read like ONE block
========================================================= */
#valki-root .valki-modal > .valki-modal-header,
#valki-root .valki-modal > .valki-messages,
#valki-root .valki-modal > .valki-chat-form{
  background: var(--chat-block-bg);
  backdrop-filter: blur(var(--chat-block-blur));
  -webkit-backdrop-filter: blur(var(--chat-block-blur));

  border-left: 1px solid var(--chat-block-border);
  border-right: 1px solid var(--chat-block-border);
}

#valki-root .valki-modal > .valki-modal-header{
  border-top: 1px solid rgba(255,255,255,.12);
}

#valki-root .valki-modal > .valki-chat-form{
  border-bottom: 1px solid rgba(255,255,255,.12);
}

/* Small highlights for depth */
#valki-root .valki-modal > .valki-modal-header,
#valki-root .valki-modal > .valki-chat-form{
  position: relative;
}
#valki-root .valki-modal > .valki-modal-header::after{
  content:"";
  position:absolute;
  left:0; right:0; bottom:0;
  height:1px;
  background: rgba(255,255,255,.06);
  pointer-events:none;
}
#valki-root .valki-modal > .valki-chat-form::before{
  content:"";
  position:absolute;
  left:0; right:0; top:0;
  height:1px;
  background: rgba(255,255,255,.06);
  pointer-events:none;
}

#valki-root .valki-messages,
#valki-root .valki-messages-inner{
  overflow-anchor: none;
}

/* =========================================================
   Messages â€” HARD column lock
========================================================= */
#valki-root .valki-messages{
  flex:1 1 auto;
  min-height:0;
  overflow-y:auto;
  overscroll-behavior:contain;
  -webkit-overflow-scrolling:touch;
  padding: 18px 0 10px;
  display: block !important;
  width: 100% !important;
  scrollbar-width:thin;
  scrollbar-color: rgba(255,255,255,.22) transparent;
}

#valki-root .valki-messages::-webkit-scrollbar{ width: 8px; }
#valki-root .valki-messages::-webkit-scrollbar-track{ background: transparent; }
#valki-root .valki-messages::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.18);
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.55);
}
#valki-root .valki-messages::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,.26); }

#valki-root .valki-messages-inner{
  max-width: var(--col) !important;
  width: 100% !important;
  margin: 0 auto !important;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
}

#valki-root .valki-messages-inner:empty{ min-height: 220px; }

#valki-root .valki-msg-row{
  display:flex;
  margin: 14px 0;
  gap: 10px;
  max-width: var(--col) !important;
  margin-left: auto !important;
  margin-right: auto !important;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
}
#valki-root .valki-msg-row.user{ justify-content:flex-end; }
#valki-root .valki-msg-row.bot{ justify-content:flex-start; }

#valki-root .valki-bot-avatar-wrap{ flex:0 0 auto; padding-top: 2px; }
#valki-root .valki-bot-avatar{
  width:26px;height:26px;border-radius:50%;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.05);
}

#valki-root .valki-msg-bubble{
  max-width: 680px;
  width: fit-content;
  padding: 10px 14px;
  border-radius: var(--radius);
  line-height: 1.58;
  font-size: 15px;
  color: rgba(255,255,255,.92);
  background: transparent;
  word-wrap: break-word;
  user-select:text;
}

#valki-root .valki-msg-row.bot .valki-msg-bubble{
  background: rgba(255,255,255,.035);
  border: 1px solid rgba(255,255,255,.08);
}

#valki-root .valki-msg-row.user .valki-msg-bubble{
  background: #f1f1f1;
  border: 1px solid rgba(255,255,255,.20);
  color: #0b0b0b;
  box-shadow: 0 10px 28px rgba(0,0,0,.30);
}

#valki-root .valki-msg-bubble a{
  color: var(--brand-2);
  text-decoration:none;
  font-weight: 650;
}
#valki-root .valki-msg-bubble a:hover{ text-decoration:underline; }

#valki-root .valki-msg-bubble code{
  font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  font-size: 13px;
  background: rgba(255,255,255,.08);
  padding: 1px 5px;
  border-radius: 6px;
}

#valki-root .valki-typing-bar{ display:inline-flex; align-items:center; gap: 8px; }
#valki-root .valki-typing-dots{ display:inline-flex; gap: 4px; }
#valki-root .valki-typing-dots span{
  width:6px;height:6px;border-radius:50%;
  background: rgba(255,255,255,.72);
  animation: valkiBounce 1.2s infinite ease-in-out;
}
#valki-root .valki-typing-dots span:nth-child(2){ animation-delay:.15s; }
#valki-root .valki-typing-dots span:nth-child(3){ animation-delay:.30s; }

@keyframes valkiBounce{
  0%,60%,100%{ transform:translateY(0); opacity:.45; }
  30%{ transform:translateY(-3px); opacity:1; }
}
#valki-root .valki-typing-label{ font-size:12px; color: var(--muted); }

/* =========================================================
   Composer â€” HARD column lock
========================================================= */
#valki-root .valki-chat-form{
  border-top: 1px solid rgba(255,255,255,.08);
  background: transparent;
  backdrop-filter: none;
  padding: 12px 0 var(--valki-chat-pad-bottom) !important;
}

#valki-root .valki-chat-form-inner{
  max-width: var(--col) !important;
  width: 100% !important;
  margin: 0 auto !important;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
}

#valki-root .valki-chat-inner{
  display:flex;
  align-items:flex-end;
  gap: 10px;
  padding: 10px 12px;
  border-radius: 26px;
  background: rgba(255,255,255,.045);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  transition: border-color .15s ease, background .15s ease, box-shadow .15s ease;
}

#valki-root .valki-chat-inner:focus-within{
  background: rgba(255,255,255,.055);
  border-color: rgba(255,255,255,.20);
  box-shadow: 0 20px 70px rgba(0,0,0,.62), 0 0 0 3px var(--ring);
}

#valki-root .valki-chat-attach{
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.12);
  display:flex;
  align-items:center;
  justify-content:center;
  color: rgba(255,255,255,.86);
  transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
}
#valki-root .valki-chat-attach:hover{
  transform: translateY(-1px);
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.18);
}
#valki-root .valki-chat-attach[disabled]{ opacity:.55; pointer-events:none; }

#valki-root .valki-chat-input{
  flex: 1 1 auto;
  min-width: 0;
  padding: 10px 2px;
  border:none;
  background: transparent;
  color: rgba(255,255,255,.92);
  font-size: 16px;
  line-height: 1.5;
  resize:none;
  overflow-y:hidden;
  white-space: pre-wrap;
  word-break: break-word;
  caret-color: rgba(255,255,255,.86);
}
#valki-root .valki-chat-input::placeholder{ color: rgba(255,255,255,.30); }

#valki-root .valki-chat-send{
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--btn-fill);
  color: var(--btn-text);
  border: 1px solid rgba(255,255,255,.16);
  display:flex;
  align-items:center;
  justify-content:center;
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
  transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
#valki-root .valki-chat-send:hover{
  transform: translateY(-1px);
  box-shadow: 0 14px 34px rgba(0,0,0,.42);
}
#valki-root .valki-chat-send[disabled]{ opacity:.55; pointer-events:none; }

/* Attachments tray */
#valki-root .valki-attachments{
  max-width: var(--col) !important;
  margin: 10px auto 0;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
}

/* âœ… Attachments thumbnails (was missing -> "buggy" feel) */
#valki-root .valki-attachment{
  position: relative;
  width: 58px;
  height: 58px;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.04);
  box-shadow: 0 10px 26px rgba(0,0,0,.35);
}

#valki-root .valki-attachment img{
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

#valki-root .valki-attachment-remove{
  position: absolute;
  top: 6px;
  right: 6px;
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: rgba(0,0,0,.55);
  border: 1px solid rgba(255,255,255,.18);
  color: rgba(255,255,255,.92);
  display:flex;
  align-items:center;
  justify-content:center;
  line-height: 1;
}

/* =========================================================
   Extra blur + â€œblokâ€ feel voor composer (vooral mobiel)
========================================================= */

/* Composer background (het hele onderste blok) */
#valki-root .valki-chat-form{
  background: rgba(0,0,0,.30); /* iets donkerder zodat blur beter leest */
  backdrop-filter: blur(18px) saturate(120%);
  -webkit-backdrop-filter: blur(18px) saturate(120%);
}

/* De pill zelf (verzendbalk / input container) */
#valki-root .valki-chat-inner{
  background: rgba(12,12,12,.38);
  backdrop-filter: blur(22px) saturate(125%);
  -webkit-backdrop-filter: blur(22px) saturate(125%);

  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
}

/* Buttons ook iets â€œglassyâ€ */
#valki-root .valki-chat-attach,
#valki-root .valki-chat-send{
  backdrop-filter: blur(14px) saturate(120%);
  -webkit-backdrop-filter: blur(14px) saturate(120%);
}

/* Mobile: blur extra boosten + iets meer tint (werkt beter op iOS/Android) */
@media (max-width: 640px){
  #valki-root .valki-chat-form{
    background: rgba(0,0,0,.36);
    backdrop-filter: blur(22px) saturate(125%);
    -webkit-backdrop-filter: blur(22px) saturate(125%);
  }

  #valki-root .valki-chat-inner{
    background: rgba(10,10,10,.48);
    backdrop-filter: blur(28px) saturate(130%);
    -webkit-backdrop-filter: blur(28px) saturate(130%);
  }
}

/* Fallback als backdrop-filter niet supported is (B2B-proof) */
@supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  #valki-root .valki-chat-form{
    background: rgba(0,0,0,.62);
  }
  #valki-root .valki-chat-inner{
    background: rgba(12,12,12,.72);
  }
}

/* =========================================================
   Composer + disclaimer = Ã©Ã©n glass block
========================================================= */

/* Disclaimer onderdeel maken van de glass look */
#valki-root .valki-disclaimer{
  margin-top: 8px;
  padding: 6px 12px 0;
  color: rgba(255,255,255,.62);

  /* subtiele scheiding maar geen â€œlos blokâ€ gevoel */
  border-top: 1px solid rgba(255,255,255,.08);

  /* zelf geen blur nodig â€” valt visueel binnen de parent */
  background: transparent;
}

/* Cookie button iets cleaner/glassy */
#valki-root .valki-disclaimer-button{
  background: transparent;
  border: none;
  color: rgba(255,255,255,.70);
  font-size: 11px;
  text-decoration: underline;
  cursor: pointer;
}

#valki-root .valki-disclaimer-button:hover{
  color: rgba(255,255,255,.85);
}

/* Mobile: disclaimer sterker integreren in blur-blok */
@media (max-width: 640px){
  #valki-root .valki-disclaimer{
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,.10);
    color: rgba(255,255,255,.70);
  }
}

/* Disclaimer */
#valki-root .valki-disclaimer{
  max-width: var(--col) !important;
  margin: 6px auto 0 !important;
  padding-left: var(--gutter) !important;
  padding-right: var(--gutter) !important;
  font-size: 11px;
  line-height: 1.4;
  color: rgba(255,255,255,.55);
  text-align:center;
}

/* Keep last messages visible â€” dynamic (composer height + safe area + 2px) */
html.valki-chat-open #valki-root{
  --composer-h: 110px; /* fallback; JS zet â€˜m exact */
}

html.valki-chat-open #valki-root .valki-messages-inner{
  padding-bottom: calc(var(--composer-h, 110px) + env(safe-area-inset-bottom) + 2px) !important;
}

/* Optional: makes wheel/touch scroll land nicely above composer */
html.valki-chat-open #valki-root .valki-messages{
  scroll-padding-bottom: calc(var(--composer-h, 110px) + env(safe-area-inset-bottom) + 2px);
}

/* Mobile tweaks + disable vignette/blur */
@media (max-width:640px){
  #valki-root{
    --gutter: 14px;
    --col: 720px;
  }

  #valki-root .valki-modal{
    box-shadow: none;
  }

  #valki-root .valki-modal::before,
  #valki-root .valki-modal::after{
    display:none;
  }

  #valki-root .valki-modal > .valki-modal-header,
  #valki-root .valki-modal > .valki-messages,
  #valki-root .valki-modal > .valki-chat-form{
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border-left: none;
    border-right: none;
  }

  #valki-root .valki-chat-attach{ width: 38px; height: 38px; }
  #valki-root .valki-chat-send{ width: 38px; height: 38px; }
  #valki-root .valki-bubble{
    right: 14px;
    bottom: calc(14px + env(safe-area-inset-bottom));
    width: 62px;
    height: 62px;
  }
}

/* =========================================================
   Bot message bubble â€” subtle glass blur for readability
========================================================= */

#valki-root .valki-msg-row.bot .valki-msg-bubble{
  background: rgba(20,20,20,.42); /* iets transparant */
  border: 1px solid rgba(255,255,255,.10);

  backdrop-filter: blur(7px) saturate(120%);
  -webkit-backdrop-filter: blur(7px) saturate(120%);

  box-shadow:
    0 8px 28px rgba(0,0,0,.35),
    inset 0 1px rgba(255,255,255,.04);

  color: rgba(255,255,255,.94);
}

@media (max-width: 640px){
  #valki-root .valki-msg-row.bot .valki-msg-bubble{
    background: rgba(16,16,16,.52);
    backdrop-filter: blur(14px) saturate(125%);
    -webkit-backdrop-filter: blur(14px) saturate(125%);
  }
}

@supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  #valki-root .valki-msg-row.bot .valki-msg-bubble{
    background: rgba(20,20,20,.75);
  }
}

/* Utility */
#valki-root .valki-hidden{ display:none !important; }
</style>

<div class="valki-root" id="valki-root">

  <!-- Floating Bubble Launcher -->
  <button id="valki-bubble" class="valki-bubble" type="button" aria-label="Open Valki chat">
    <span class="valki-bubble-ping" id="valki-bubble-ping" aria-hidden="true" style="display:none;"></span>

    <svg class="valki-bubble-icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path
        d="M21 12c0 4.418-4.03 8-9 8a11.1 11.1 0 0 1-3.86-.68L3 20l1.54-3.08A7.3 7.3 0 0 1 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8Z"
        stroke="currentColor"
        stroke-width="2.2"
        stroke-linejoin="round">
      </path>

      <path
        d="M7.5 12h.01M12 12h.01M16.5 12h.01"
        stroke="currentColor"
        stroke-width="2.8"
        stroke-linecap="round">
      </path>
    </svg>

    <span class="valki-bubble-badge" id="valki-bubble-badge" aria-hidden="true" style="display:none;">1</span>
  </button>

  <!-- Chat overlay -->
  <div id="valki-overlay" class="valki-overlay" aria-hidden="true">
    <div class="valki-modal" role="dialog" aria-modal="true" aria-labelledby="valki-title">

      <!-- Header -->
      <div class="valki-modal-header">
        <div class="valki-modal-header-inner">

          <div class="valki-header-left">
            <img class="valki-header-avatar" id="valki-header-avatar"
                 src="https://valki.wiki/blogmedia/Valki%20Talki.jpg"
                 alt="Valki avatar" />
            <div class="valki-modal-title-text">
              <span class="name" id="valki-title">Valki Talki</span>
              <span class="session" id="valki-session-label">Guest ðŸŸ </span>
            </div>
          </div>

          <div class="valki-header-actions">
            <button class="valki-pill primary" id="valki-loginout-btn" type="button" title="Login">Login</button>
            <button class="valki-pill" id="valki-deleteall-btn" type="button" title="Delete all messages">Delete</button>
            <button id="valki-close" class="valki-close-btn" type="button" aria-label="Close chat">âœ•</button>
          </div>

        </div>
      </div>

      <!-- Messages -->
      <div id="valki-messages" class="valki-messages" role="log" aria-live="polite">
        <div class="valki-messages-inner" id="valki-messages-inner"></div>
      </div>

      <!-- Composer -->
      <form id="valki-chat-form" class="valki-chat-form" autocomplete="off">
        <div class="valki-chat-form-inner">

          <div class="valki-chat-inner">
            <button class="valki-chat-attach" id="valki-chat-attach" type="button" aria-label="Upload image">
              <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.9-9.9a4 4 0 015.66 5.66l-9.9 9.9a2 2 0 01-2.83-2.83l9.19-9.19"></path>
              </svg>
            </button>

            <input id="valki-file-input" type="file" accept="image/jpeg,image/png" multiple style="display:none" />

            <textarea id="valki-chat-input" class="valki-chat-input" rows="1"
                      placeholder=""
                      aria-label="Message Valki"
                      enterkeyhint="send"></textarea>

            <button class="valki-chat-send" id="valki-chat-send" type="submit" aria-label="Send message">
              <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 19V5"></path>
                <path d="M5 12l7-7 7 7"></path>
              </svg>
            </button>
          </div>

          <div class="valki-attachments" id="valki-attachments" aria-label="Attachments" style="display:none;"></div>

          <div class="valki-disclaimer">
            <div>Valki signals may distort. Verify info.</div>
            <button type="button" class="valki-disclaimer-button"
                    onclick="if (typeof displayPreferenceModal === 'function') { displayPreferenceModal(); }">
              See cookie preferences.
            </button>
          </div>

        </div>
      </form>

    </div>
  </div>

  <!-- Auth / Login overlay -->
  <div id="valki-auth-overlay" class="valki-auth-overlay" aria-hidden="true">
    <div class="valki-auth-modal" role="dialog" aria-modal="true" aria-label="Login required">
      <div class="valki-auth-header">
        <img src="https://valki.wiki/blogmedia/Valki%20Talki.jpg" class="valki-auth-avatar" alt="Valki avatar" />
      </div>
      <h2 class="valki-auth-title" id="valki-auth-title">Log in to continue</h2>
      <p class="valki-auth-subtitle" id="valki-auth-subtitle">Sign in to keep your chat history and manage messages.</p>

      <div class="valki-auth-buttons">
        <button type="button" class="valki-auth-btn primary" id="valki-login-discord-btn">
          <span aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M20.3 4.7a19.6 19.6 0 0 0-4.9-1.5l-.2.3c1.8.5 2.6 1.2 2.6 1.2a16.4 16.4 0 0 0-5.8-1.8 16.4 16.4 0 0 0-5.8 1.8s.8-.7 2.6-1.2l-.2-.3A19.6 19.6 0 0 0 3.7 4.7C1.4 8 1 11 1 14c1.4 2.1 3.5 3.4 5.7 4 .4-.6.9-1.4 1.2-2.1-.7-.3-1.4-.6-2-.9l.5-.4c1.2.6 2.5 1 3.8 1.2a15 15 0 0 0 3.6 0c1.3-.2 2.6-.6 3.8-1.2l.5.4c-.6.3-1.3.6-2 .9.4.8.8 1.5 1.2 2.1 2.2-.6 4.3-1.9 5.7-4 0-3-.4-6-2.7-9.3ZM9 13.4c-.8 0-1.4-.7-1.4-1.6s.6-1.6 1.4-1.6 1.4.7 1.4 1.6-.6 1.4-1.4 1.6Zm6 0c-.8 0-1.4-.7-1.4-1.6s.6-1.6 1.4-1.6 1.4.7 1.4 1.6-.6 1.4-1.4 1.6Z"></path>
            </svg>
          </span>
          <span>Continue with Discord</span>
        </button>

        <button type="button" class="valki-auth-btn" id="valki-login-google-btn">
          <span aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
              <path d="M12 10.2v3.9h5.4c-.2 1.3-1.6 3.9-5.4 3.9-3.3 0-6-2.7-6-6s2.7-6 6-6c1.9 0 3.2.8 3.9 1.5l2.7-2.6C17 3.3 14.8 2.4 12 2.4 6.9 2.4 2.8 6.5 2.8 11.6S6.9 20.8 12 20.8c5.9 0 9.8-4.1 9.8-9.8 0-.7-.1-1.2-.2-1.8H12z"></path>
            </svg>
          </span>
          <span>Continue with Google</span>
        </button>

        <button type="button" class="valki-auth-btn" id="valki-join-discord-btn">Join Discord server</button>
      </div>

      <div class="valki-auth-note" id="valki-auth-note">Guest limits apply.</div>
      <div class="valki-auth-dismiss" id="valki-auth-dismiss">Not now</div>
    </div>
  </div>

  <!-- Confirm delete all -->
  <div id="valki-confirm-overlay" class="valki-confirm-overlay" aria-hidden="true">
    <div class="valki-confirm-modal" role="dialog" aria-modal="true" aria-label="Confirm delete">
      <h3 class="valki-confirm-title">Delete all messages?</h3>
      <p class="valki-confirm-sub">This will remove your chat history for this session.</p>
      <div class="valki-confirm-actions">
        <button type="button" class="valki-confirm-btn" id="valki-confirm-no"><span>No</span></button>
        <button type="button" class="valki-confirm-btn danger" id="valki-confirm-yes"><span>Yes, delete</span></button>
      </div>
    </div>
  </div>

  <!-- Confirm logout (âœ… class made consistent) -->
  <div id="valki-logout-overlay" class="valki-logout-overlay" aria-hidden="true" style="display:none;">
    <div class="valki-confirm-modal" role="dialog" aria-modal="true" aria-label="Confirm logout">
      <h3 class="valki-confirm-title">Log out?</h3>
      <p class="valki-confirm-sub">You will switch back to guest mode on this device.</p>
      <div class="valki-confirm-actions">
        <button type="button" class="valki-confirm-btn" id="valki-logout-no"><span>Cancel</span></button>
        <button type="button" class="valki-confirm-btn danger" id="valki-logout-yes"><span>Yes, log out</span></button>
      </div>
    </div>
  </div>

</div>

<script>
(function(){
"use strict";

/* =============================== CONFIG ================================ */
const BASE_URL = "https://auth.valki.wiki";
const API_VALKI = BASE_URL + "/api/valki";
const API_ME = BASE_URL + "/api/me";
const API_MESSAGES = BASE_URL + "/api/messages";
const API_CLEAR = BASE_URL + "/api/clear";
const API_IMPORT_GUEST = BASE_URL + "/api/import-guest";

const AUTH_DISCORD_START = BASE_URL + "/auth/discord";
const AUTH_GOOGLE_START = BASE_URL + "/auth/google";
const DISCORD_INVITE_URL = "https://discord.com/invite/vqDJuGJN2u";

const AVATAR_URL = "https://valki.wiki/blogmedia/Valki%20Talki.jpg";

const GUEST_FREE_ROUND_SIZE = 3;
const GUEST_MAX_ROUNDS = 2;

const AUTH_KEY = "valki_auth_token_v1";
const HISTORY_KEY = "valki_history_v20";
const GUEST_METER_KEY = "valki_guest_meter_v1";
const CLIENT_ID_KEY = "valki_client_id_v20";

/* Bubble badge state */
const BUBBLE_SEEN_KEY = "valki_bubble_seen_v1";

const MSG_GENERIC_ERROR = "Something went wrong talking to Valki.";
const MSG_NO_RESPONSE = "â€¦krrzzztâ€¦ no response received.";

const CHAT_MAX_LINES = 4;

/* Attachments */
const MAX_FILES = 4;
const MAX_BYTES = 5 * 1024 * 1024; // 5MB per file

/* =============================== DOM ================================ */
const $ = (id)=>document.getElementById(id);

const root = $("valki-root");
const bubble = $("valki-bubble");
const bubbleBadge = $("valki-bubble-badge");
const bubblePing = $("valki-bubble-ping");

const overlay = $("valki-overlay");
const closeBtn = $("valki-close");

const headerAvatar = $("valki-header-avatar");
const headerTitle = $("valki-title");
const sessionLabel = $("valki-session-label");

const loginOutBtn = $("valki-loginout-btn");
const deleteAllBtn = $("valki-deleteall-btn");

const messagesEl = $("valki-messages");
const messagesInner = $("valki-messages-inner");

const chatForm = $("valki-chat-form");
const chatInput = $("valki-chat-input");
const sendBtn = $("valki-chat-send");

const attachBtn = $("valki-chat-attach");
const fileInput = $("valki-file-input");
const attachTray = $("valki-attachments");

const authOverlay = $("valki-auth-overlay");
const authTitle = $("valki-auth-title");
const authSubtitle = $("valki-auth-subtitle");
const authNote = $("valki-auth-note");
const authDismiss = $("valki-auth-dismiss");
const loginDiscordBtn = $("valki-login-discord-btn");
const loginGoogleBtn = $("valki-login-google-btn");
const joinDiscordBtn = $("valki-join-discord-btn");

const confirmOverlay = $("valki-confirm-overlay");
const confirmNo = $("valki-confirm-no");
const confirmYes = $("valki-confirm-yes");

const logoutOverlay = $("valki-logout-overlay");
const logoutNo = $("valki-logout-no");
const logoutYes = $("valki-logout-yes");

const required = [
  root, bubble, overlay, closeBtn, headerAvatar, headerTitle, sessionLabel,
  loginOutBtn, deleteAllBtn, messagesEl, messagesInner,
  chatForm, chatInput, sendBtn, attachBtn, fileInput, attachTray,
  authOverlay, authTitle, authSubtitle, authNote, authDismiss,
  loginDiscordBtn, loginGoogleBtn, joinDiscordBtn,
  confirmOverlay, confirmNo, confirmYes,
  logoutOverlay, logoutNo, logoutYes
];
if (required.some(el => !el)) return;

/* =============================== Helpers ================================ */
function cleanText(v){ return String(v ?? "").replace(/\u0000/g,"").trim(); }
function safeJsonParse(s, fallback){ try{ return JSON.parse(s); } catch { return fallback; } }
function parsePx(v){ const n = parseFloat(String(v||"").replace("px","")); return Number.isFinite(n) ? n : 0; }

function isNearBottom(el, px=90){
  return (el.scrollHeight - el.scrollTop - el.clientHeight) < px;
}
function scrollToBottom(force=false){
  if (force || isNearBottom(messagesEl)) messagesEl.scrollTop = messagesEl.scrollHeight;
}

function genId(prefix){
  try{
    // âœ… safer crypto access
    if (window.crypto && window.crypto.getRandomValues){
      const a = new Uint32Array(2);
      window.crypto.getRandomValues(a);
      const hex = Array.from(a).map(n=>n.toString(16).padStart(8,"0")).join("");
      return prefix + "-" + hex;
    }
  }catch{}
  return prefix + "-" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function setVisible(el, on){
  if (!el) return;
  el.style.display = on ? "flex" : "none";
  el.setAttribute("aria-hidden", on ? "false" : "true");
  if (on) requestAnimationFrame(()=> el.classList.add("is-visible"));
  else el.classList.remove("is-visible");
}

/* =============================== Helpers ================================ */
function cleanText(v){
  return String(v ?? "").replace(/\u0000/g, "").trim();
}

function safeJsonParse(raw, fallback){
  if (typeof raw !== "string" || !raw) return fallback;
  try{
    return JSON.parse(raw);
  }catch{
    return fallback;
  }
}

function parsePx(v){
  // Handles: "12px", "12.5px", 12, null, undefined
  const n = parseFloat(String(v ?? "").replace("px", ""));
  return Number.isFinite(n) ? n : 0;
}

/* =============================== Scroll helpers ================================ */
function isNearBottom(el, thresholdPx = 90){
  if (!el) return true;
  const remaining = el.scrollHeight - el.scrollTop - el.clientHeight;
  return remaining < thresholdPx;
}

function scrollToBottom(force = false){
  if (!messagesEl) return;
  if (force || isNearBottom(messagesEl)) {
    // +10000 helps with iOS/Safari rounding/anchoring weirdness
    messagesEl.scrollTop = messagesEl.scrollHeight + 10000;
  }
}

/* If you want the â€œhardâ€ iOS-safe version as a dedicated helper: */
function scrollToBottomHard(){
  if (!messagesEl) return;
  requestAnimationFrame(()=>{
    messagesEl.scrollTop = messagesEl.scrollHeight + 10000;
    requestAnimationFrame(()=>{
      messagesEl.scrollTop = messagesEl.scrollHeight + 10000;
    });
  });
}

/* =============================== ID helper ================================ */
function genId(prefix = "id"){
  const p = String(prefix || "id");

  try{
    const c = window.crypto;
    if (c && typeof c.getRandomValues === "function"){
      const a = new Uint32Array(2);
      c.getRandomValues(a);
      const hex = Array.from(a, n => n.toString(16).padStart(8, "0")).join("");
      return `${p}-${hex}`;
    }
  }catch{}

  return `${p}-${Math.random().toString(16).slice(2)}${Date.now().toString(16)}`;
}

/* =============================== Visibility helper ================================ */
function setVisible(el, on){
  if (!el) return;

  const show = !!on;
  el.style.display = show ? "flex" : "none";
  el.setAttribute("aria-hidden", show ? "false" : "true");

  if (show){
    requestAnimationFrame(()=> el.classList.add("is-visible"));
  } else {
    el.classList.remove("is-visible");
  }
}

/* =============================== Layout metrics (DEVICE-PROOF) ================================ */
/* 1) true viewport height (iOS rotate/keyboard safe) -> --valki-vh */
/* 2) true composer height -> --composer-h */
let _layoutRaf = 0;

function updateValkiVh(){
  try{
    const vv = window.visualViewport;
    const height = (vv && vv.height) ? vv.height : window.innerHeight;
    root.style.setProperty("--valki-vh", (height * 0.01) + "px");
  }catch{}
}

function updateComposerH(){
  try{
    const rect = chatForm.getBoundingClientRect();
    const h = Math.max(0, Math.round(rect?.height || 0));
    if (h) root.style.setProperty("--composer-h", h + "px");
  }catch{}
}

function updateLayoutMetrics(){
  updateValkiVh();
  updateComposerH();
}

function scheduleLayoutMetrics(){
  if (_layoutRaf) return;
  _layoutRaf = requestAnimationFrame(()=>{
    _layoutRaf = 0;
    updateLayoutMetrics();
  });
}

/* Auto-update when composer height changes (attachments/disclaimer/textarea growth) */
let _composerRO = null; // âœ… now used
try{
  if (window.ResizeObserver){
    _composerRO = new ResizeObserver(()=> updateComposerH());
    _composerRO.observe(chatForm);
  }
}catch{}

/* =============================== Locale placeholders ================================ */
const searchCopy = {
  en: "What went wrong?",
  nl: "Wat ging er mis?",
  de: "Was ist schiefgelaufen?",
  fr: "Quâ€™est-ce qui sâ€™est mal passÃ© ?",
  es: "Â¿QuÃ© saliÃ³ mal?",
  it: "Cosa Ã¨ andato storto?",
  pt: "O que deu errado?",
  pl: "Co poszÅ‚o nie tak?",
  ja: "ä½•ãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸï¼Ÿ",
  zh: "å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Ÿ",
  ko: "ë¬´ì—‡ì´ ìž˜ëª»ëë‚˜ìš”?",
  ar: "Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø« Ø®Ø·Ø£ØŸ",
  tr: "Ne yanlÄ±ÅŸ gitti?"
};

function pickLocale(){
  const langs = (navigator.languages && navigator.languages.length) ? navigator.languages : [navigator.language || "en"];
  for (const l of langs){
    const lang = String(l).toLowerCase();
    const base = lang.split("-")[0];
    if (searchCopy[lang]) return lang;
    if (searchCopy[base]) return base;
  }
  return "en";
}

function applyPlaceholders(){
  const loc = pickLocale();
  const txt = searchCopy[loc] || searchCopy.en;
  chatInput.placeholder = txt;
}
applyPlaceholders();
window.addEventListener("languagechange", applyPlaceholders);

/* =============================== Auth token + user state ================================ */
function getAuthToken(){
  try{ return localStorage.getItem(AUTH_KEY) || ""; } catch { return ""; }
}
function setAuthToken(tok){
  try{ localStorage.setItem(AUTH_KEY, String(tok||"")); } catch {}
}
function clearAuthToken(){
  try{ localStorage.removeItem(AUTH_KEY); } catch {}
}
function isLoggedIn(){ return !!getAuthToken(); }

let me = null;

async function fetchMe(){
  const tok = getAuthToken();
  if (!tok){ me = null; return null; }
  try{
    const r = await fetch(API_ME, { headers:{ Authorization:"Bearer " + tok } });
    const j = await r.json().catch(()=>null);
    if (j && j.loggedIn && j.user){
      me = j.user;
      return me;
    }
  }catch{}
  me = null;
  return null;
}

function updateSessionLabel(){
  if (me && me.name){ sessionLabel.textContent = me.name + " ðŸŸ¢"; return; }
  sessionLabel.textContent = isLoggedIn() ? "you ðŸŸ¢" : "Guest ðŸŸ ";
}

function updateLoginOutButtonLabel(){
  if (isLoggedIn()){
    loginOutBtn.style.display = "none";
  } else {
    loginOutBtn.style.display = "inline-flex";
    loginOutBtn.textContent = "Login";
  }
}

function hasAnyRealMessages(){
  const rows = messagesInner.querySelectorAll(".valki-msg-row");
  for (const r of rows){
    if (r.querySelector(".valki-typing-bar")) continue;
    return true;
  }
  return false;
}

function updateDeleteButtonVisibility(){
  deleteAllBtn.style.display = hasAnyRealMessages() ? "inline-flex" : "none";
}

function updateDeleteButtonState(isBusy){
  if (!hasAnyRealMessages()) return;
  deleteAllBtn.disabled = !!isBusy;
  deleteAllBtn.style.opacity = isBusy ? ".55" : "";
  deleteAllBtn.style.pointerEvents = isBusy ? "none" : "";
}

/* =============================== Bubble badge (unread / new) ================================ */
function showBubbleBadge(label="1"){
  bubbleBadge.style.display = "flex";
  bubbleBadge.textContent = String(label);
  bubblePing.style.display = "block";
}
function hideBubbleBadge(){
  bubbleBadge.style.display = "none";
  bubblePing.style.display = "none";
}

function markBubbleSeen(){
  try{ localStorage.setItem(BUBBLE_SEEN_KEY, "1"); }catch{}
  hideBubbleBadge();
}

function shouldShowBubbleBadge(){
  try{
    const seen = localStorage.getItem(BUBBLE_SEEN_KEY) === "1";
    return !seen;
  }catch{
    return true;
  }
}

/* =============================== Guest meter ================================ */
function getGuestMeter(){
  const raw = (()=>{ try{ return localStorage.getItem(GUEST_METER_KEY) || ""; }catch{ return ""; } })();
  const m = safeJsonParse(raw, null) || { count:0, roundsShown:0 };
  m.count = Number.isFinite(Number(m.count)) ? Number(m.count) : 0;
  m.roundsShown = Number.isFinite(Number(m.roundsShown)) ? Number(m.roundsShown) : 0;
  return m;
}
function setGuestMeter(m){ try{ localStorage.setItem(GUEST_METER_KEY, JSON.stringify(m)); }catch{} }
function resetGuestMeter(){ try{ localStorage.removeItem(GUEST_METER_KEY); }catch{} }

function guestHardBlocked(){
  if (isLoggedIn()) return false;
  const m = getGuestMeter();
  return m.count >= (GUEST_FREE_ROUND_SIZE * GUEST_MAX_ROUNDS);
}

function maybePromptLoginAfterSend(){
  if (isLoggedIn()) return;
  const m = getGuestMeter();
  const threshold = (m.roundsShown + 1) * GUEST_FREE_ROUND_SIZE;
  if (m.count >= threshold && m.roundsShown < GUEST_MAX_ROUNDS){
    m.roundsShown += 1;
    setGuestMeter(m);
    openAuthOverlay({ hard: (m.roundsShown >= GUEST_MAX_ROUNDS) });
  }
}

function bumpGuestCount(){
  if (isLoggedIn()) return;
  const m = getGuestMeter();
  m.count += 1;
  setGuestMeter(m);
}

/* =============================== Guest history ================================ */
function loadGuestHistory(){
  try{
    const raw = localStorage.getItem(HISTORY_KEY);
    const arr = safeJsonParse(raw, []);
    if (!Array.isArray(arr)) return [];
    return arr.filter(x => x && (x.type==="user"||x.type==="bot") && typeof x.text==="string");
  }catch{
    return [];
  }
}

function saveGuestHistory(arr){
  try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch{}
}

function clearGuestHistory(){
  try{ localStorage.removeItem(HISTORY_KEY); }catch{}
}

let guestHistory = loadGuestHistory();

/* =============================== Markdown (lazy) ================================ */
let mdReady = false;
let mdLoading = null;

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s = document.createElement("script");
    s.src = src;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });
}

async function ensureMarkdownLibs(){
  if (mdReady) return;
  if (mdLoading) return mdLoading;
  mdLoading = (async()=>{
    await loadScript("https://cdn.jsdelivr.net/npm/marked/marked.min.js");
    await loadScript("https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js");
    mdReady = true;
  })();
  return mdLoading;
}

function renderMarkdown(text){
  if (!text) return "";
  if (window.marked){
    let html = window.marked.parse(text, { breaks:true });
    if (window.DOMPurify) html = window.DOMPurify.sanitize(html);
    return html;
  }
  return String(text)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/\n/g,"<br>");
}

function hardenLinks(containerEl){
  if (!containerEl) return;
  containerEl.querySelectorAll("a").forEach(a=>{
    const href = (a.getAttribute("href")||"").trim();
    if (/^javascript:/i.test(href)) a.removeAttribute("href");
    a.setAttribute("target","_blank");
    a.setAttribute("rel","noopener noreferrer");
  });
}

/* =============================== Messages UI ================================ */
function createMessageRow({ type, text }){
  const row = document.createElement("div");
  row.className = "valki-msg-row " + (type === "user" ? "user" : "bot");

  if (type === "bot"){
    const avatarWrap = document.createElement("div");
    avatarWrap.className = "valki-bot-avatar-wrap";
    const avatar = document.createElement("img");
    avatar.className = "valki-bot-avatar";
    avatar.src = AVATAR_URL;
    avatar.alt = "Valki icon";
    avatarWrap.appendChild(avatar);
    row.appendChild(avatarWrap);
  }

  const bubbleEl = document.createElement("div");
  bubbleEl.className = "valki-msg-bubble";

  if (type === "bot"){
    bubbleEl.innerHTML = renderMarkdown(text);
    hardenLinks(bubbleEl);
  } else {
    bubbleEl.textContent = text;
  }

  row.appendChild(bubbleEl);
  return row;
}

async function addMessage({ type, text }){
  const stick = isNearBottom(messagesEl);
  if (type === "bot") await ensureMarkdownLibs();
  messagesInner.appendChild(createMessageRow({ type, text }));
  scrollToBottom(stick);
  updateDeleteButtonVisibility();
}

function clearMessagesUI(){
  messagesInner.innerHTML = "";
  updateDeleteButtonVisibility();
}

function createTypingRow(){
  const typingRow = document.createElement("div");
  typingRow.className = "valki-msg-row bot";

  const avatarWrap = document.createElement("div");
  avatarWrap.className = "valki-bot-avatar-wrap";
  const avatar = document.createElement("img");
  avatar.className = "valki-bot-avatar";
  avatar.src = AVATAR_URL;
  avatar.alt = "Valki icon";
  avatarWrap.appendChild(avatar);
  typingRow.appendChild(avatarWrap);

  const bubbleEl = document.createElement("div");
  bubbleEl.className = "valki-msg-bubble";
  bubbleEl.innerHTML = `
    <div class="valki-typing-bar">
      <span class="valki-typing-dots"><span></span><span></span><span></span></span>
      <span class="valki-typing-label">Analyzing the signalâ€¦</span>
    </div>`;
  typingRow.appendChild(bubbleEl);

  const stick = isNearBottom(messagesEl);
  messagesInner.appendChild(typingRow);
  scrollToBottom(stick);

  return typingRow;
}

/* =============================== Overlay open/close (iOS safe) ================================ */
function isChatOpen(){ return overlay.classList.contains("is-visible"); }

function lockBodyScroll(){
  const y = window.scrollY || 0;
  document.body.dataset.valkiScrollY = String(y);
  document.body.style.position = "fixed";
  document.body.style.top = "-" + y + "px";
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.width = "100%";
  document.body.style.overflow = "hidden";
  document.body.style.touchAction = "none";
  document.documentElement.classList.add("valki-chat-open");
}

function unlockBodyScroll(){
  const y = parseInt(document.body.dataset.valkiScrollY || "0", 10);
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.width = "";
  document.body.style.overflow = "";
  document.body.style.touchAction = "";
  delete document.body.dataset.valkiScrollY;
  document.documentElement.classList.remove("valki-chat-open");
  window.scrollTo({ top:y, behavior:"auto" });
}

function openOverlay(){
  setVisible(overlay, true);
  lockBodyScroll();
  setTimeout(()=>{
    updateComposerH();
    scrollToBottom(true);
    try{ chatInput.focus({ preventScroll:true }); }
    catch { chatInput.focus(); }
    clampComposer();
    updateComposerH();
  }, 60);
}

function closeOverlay(){
  overlay.classList.remove("is-visible");
  setTimeout(()=>{
    setVisible(overlay, false); // âœ… consistent close
    unlockBodyScroll();
  }, 220);
}

/* =============================== Composer auto-grow ================================ */
function computeLineHeightPx(el){
  const cs = getComputedStyle(el);
  const fontSize = parsePx(cs.fontSize) || 16;
  const lh = cs.lineHeight;
  if (!lh || lh==="normal") return Math.round(fontSize*1.35);
  if (String(lh).endsWith("px")) return Math.round(parsePx(lh));
  const asNum = parseFloat(lh);
  if (Number.isFinite(asNum)) return Math.round(fontSize*asNum);
  return Math.round(fontSize*1.35);
}

function clampComposer(){
  chatInput.style.height = "auto";
  const cs = getComputedStyle(chatInput);
  const lh = computeLineHeightPx(chatInput);
  const padTop = parsePx(cs.paddingTop);
  const padBot = parsePx(cs.paddingBottom);
  const maxH = Math.ceil(lh * CHAT_MAX_LINES + padTop + padBot);
  const scrollH = chatInput.scrollHeight;
  const next = Math.min(scrollH, maxH);
  chatInput.style.height = next + "px";
  chatInput.style.overflowY = (scrollH > maxH) ? "auto" : "hidden";

  updateComposerH();
}

/* =============================== Attachments (JPEG/PNG) ================================ */
let attachments = []; // { id, name, type, dataUrl }

function showAttachTray(){
  if (!attachments || attachments.length === 0){
    attachTray.style.display = "none";
    attachTray.innerHTML = "";
    updateComposerH();
    return;
  }

  attachTray.style.display = "flex";
  attachTray.innerHTML = "";

  for (const a of attachments){
    const wrap = document.createElement("div");
    wrap.className = "valki-attachment";

    const img = document.createElement("img");
    img.src = a.dataUrl;
    img.alt = a.name || "attachment";
    img.loading = "lazy";

    const rm = document.createElement("button");
    rm.type = "button";
    rm.className = "valki-attachment-remove";
    rm.textContent = "Ã—";
    rm.setAttribute("aria-label", "Remove attachment");

    rm.addEventListener("click", ()=>{
      attachments = attachments.filter(x => x.id !== a.id);
      showAttachTray();
      clampComposer();
      updateComposerH();
    });

    wrap.appendChild(img);
    wrap.appendChild(rm);
    attachTray.appendChild(wrap);
  }

  updateComposerH();
}

function readFileAsDataURL(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function addFiles(fileList){
  const files = Array.from(fileList || []);
  for (const f of files){
    if (attachments.length >= MAX_FILES) break;

    const t = String(f.type || "");
    const ok = (t === "image/jpeg" || t === "image/png");
    if (!ok) continue;
    if (f.size > MAX_BYTES) continue;

    const dataUrl = await readFileAsDataURL(f).catch(()=> "");
    if (!dataUrl) continue;

    attachments.push({ id: genId("att"), name: f.name || "image", type: t, dataUrl });
  }
  showAttachTray();
}

function setAttachmentUiDisabled(on){
  attachBtn.disabled = !!on || chatInput.disabled;
  attachBtn.style.opacity = attachBtn.disabled ? ".55" : "";
}

/* =============================== Auth overlay ================================ */
let authHard = false;

function openAuthOverlay({ hard }){
  authHard = !!hard;

  authTitle.textContent = authHard ? "Login required" : "Log in to continue";
  authSubtitle.textContent = authHard
    ? "Youâ€™ve reached the guest limit. Log in to keep chatting."
    : "Sign in to keep your chat history and manage messages.";
  authNote.textContent = authHard ? "Guest limit reached." : "Tip: you can continue as guest, but limits apply.";
  authDismiss.style.display = authHard ? "none" : "inline-block";

  setVisible(authOverlay, true);

  if (authHard){
    chatInput.disabled = true;
    sendBtn.disabled = true;
    setAttachmentUiDisabled(true);
    updateDeleteButtonState(true);
  }
}

function closeAuthOverlay(){
  if (authHard) return;
  authOverlay.classList.remove("is-visible");
  setTimeout(()=>{ authOverlay.style.display="none"; }, 180);
}

/* =============================== Confirm delete-all overlay ================================ */
function openConfirm(){ setVisible(confirmOverlay, true); }
function closeConfirm(){
  confirmOverlay.classList.remove("is-visible");
  confirmOverlay.setAttribute("aria-hidden","true");
  setTimeout(()=>{ confirmOverlay.style.display="none"; }, 180);
}

/* =============================== Logout overlay ================================ */
function openLogoutPrompt(){ setVisible(logoutOverlay, true); }
function closeLogoutPrompt(){
  logoutOverlay.classList.remove("is-visible");
  logoutOverlay.setAttribute("aria-hidden","true");
  setTimeout(()=>{ logoutOverlay.style.display="none"; }, 180);
}
logoutNo.addEventListener("click", closeLogoutPrompt);
logoutOverlay.addEventListener("click", (e)=>{ if (e.target === logoutOverlay) closeLogoutPrompt(); });

/* =============================== OAuth popup login ================================ */
function openOAuthPopup(authStartUrl, popupName){
  const returnTo = window.location.origin;
  const w = 480, h = 720;
  const y = Math.max(0, (window.screenY || 0) + ((window.outerHeight - h) / 2));
  const x = Math.max(0, (window.screenX || 0) + ((window.outerWidth - w) / 2));
  const url = authStartUrl + "?returnTo=" + encodeURIComponent(returnTo);

  const popup = window.open(
    url,
    popupName,
    `popup=yes,width=${w},height=${h},left=${Math.round(x)},top=${Math.round(y)}`
  );

  if (!popup){
    window.location.href = url;
    return;
  }
  try{ popup.focus(); }catch{}
}

function openDiscordLoginPopup(){ openOAuthPopup(AUTH_DISCORD_START, "valki_discord_login"); }
function openGoogleLoginPopup(){ openOAuthPopup(AUTH_GOOGLE_START, "valki_google_login"); }

async function importGuestIntoAccount(authToken){
  try{
    if (!Array.isArray(guestHistory) || !guestHistory.length) return;

    const payload = {
      messages: guestHistory.slice(-80).map(m => ({
        role: (m.type === "bot") ? "assistant" : "user",
        content: String(m.text || "")
      }))
    };

    await fetch(API_IMPORT_GUEST, {
      method:"POST",
      headers:{ "Content-Type":"application/json", Authorization:"Bearer " + authToken },
      body: JSON.stringify(payload)
    }).catch(()=>{});

    guestHistory = [];
    clearGuestHistory();
  }catch(e){
    console.warn("Guest import failed (non-fatal):", e);
  }
}

const BACKEND_ORIGIN = new URL(BASE_URL).origin;
window.addEventListener("message", async (ev)=>{
  if (ev.origin !== BACKEND_ORIGIN) return;
  const data = ev.data;
  if (!data || typeof data !== "object") return;
  if (data.type !== "valki_auth") return;
  if (!data.token) return;

  setAuthToken(data.token);
  await fetchMe();
  updateSessionLabel();
  updateLoginOutButtonLabel();
  resetGuestMeter();

  chatInput.disabled = false;
  sendBtn.disabled = false;
  setAttachmentUiDisabled(false);
  authHard = false;

  authOverlay.classList.remove("is-visible");
  setTimeout(()=>{ authOverlay.style.display="none"; }, 180);

  await importGuestIntoAccount(data.token);
  await loadLoggedInMessagesToUI({ forceOpen:true });
});

/* =============================== Load messages (logged-in) ================================ */
async function loadLoggedInMessagesToUI({ forceOpen=false } = {}){
  const tok = getAuthToken();
  if (!tok) return false;

  try{
    const r = await fetch(API_MESSAGES, { headers:{ Authorization:"Bearer " + tok } });
    if (!r.ok) return false;

    const j = await r.json().catch(()=>null);
    if (!j || !Array.isArray(j.messages)) return false;

    clearMessagesUI();
    for (const m of j.messages){
      const type = (m.role === "assistant") ? "bot" : "user";
      await addMessage({ type, text:String(m.content || "") });
    }

    scrollToBottom(true);
    updateDeleteButtonVisibility();
    scheduleLayoutMetrics();

    if (forceOpen && !isChatOpen()) openOverlay();
    return true;
  }catch{
    return false;
  }
}

/* =============================== Delete-all semantics ================================ */
async function clearChatAll(){
  if (isLoggedIn()){
    const tok = getAuthToken();
    try{
      const r = await fetch(API_CLEAR, { method:"POST", headers:{ Authorization:"Bearer " + tok } });
      if (r.ok){
        await loadLoggedInMessagesToUI();
        scheduleLayoutMetrics();
        return;
      }
    }catch{}
    clearMessagesUI();
    scheduleLayoutMetrics();
    return;
  }
  guestHistory = [];
  saveGuestHistory(guestHistory);
  clearMessagesUI();
  scheduleLayoutMetrics();
}

async function logout(){
  clearAuthToken();
  me = null;
  updateSessionLabel();
  updateLoginOutButtonLabel();

  chatInput.disabled = false;
  sendBtn.disabled = false;
  setAttachmentUiDisabled(false);

  attachments = [];
  showAttachTray();

  guestHistory = [];
  clearGuestHistory();
  resetGuestMeter();

  clearMessagesUI();
  await renderGuestHistoryToUI();
  scheduleLayoutMetrics();
}

/* =============================== Render guest history ================================ */
async function renderGuestHistoryToUI(){
  clearMessagesUI();
  for (const m of guestHistory){
    await addMessage({ type:m.type, text:m.text });
  }
  scrollToBottom(true);
  updateDeleteButtonVisibility();
  scheduleLayoutMetrics();
}

/* =============================== Call Valki ================================ */
let isSending = false;

/* =============================== Client ID ================================ */
function getOrCreateClientId(){
  // 1) Try existing
  try{
    const existing = localStorage.getItem(CLIENT_ID_KEY);
    if (existing && typeof existing === "string") return existing;
  }catch{}

  // 2) Create + persist
  const id = genId("valk-client");
  try{ localStorage.setItem(CLIENT_ID_KEY, id); }catch{}
  return id;
}

let clientId = getOrCreateClientId();

/* =============================== Sending state ================================ */
function setSendingState(isBusy){
  const on = !!isBusy;
  sendBtn.disabled = on || !!chatInput.disabled;
  setAttachmentUiDisabled(on);
  updateDeleteButtonState(on);
}

/* =============================== Ask Valki ================================ */
async function askValki(text){
  const q = cleanText(text);
  if (!q || isSending) return;

  // Guest hard-limit gate
  if (guestHardBlocked()){
    openAuthOverlay({ hard:true });
    return;
  }

  isSending = true;
  setSendingState(true);

  // Snapshot attachments so UI can be cleared safely in finally
  const imagesSnapshot = (attachments || []).map(a => ({
    name: a?.name || "image",
    type: a?.type || "image/jpeg",
    dataUrl: a?.dataUrl || ""
  })).filter(x => x.dataUrl);

  // UI: add user message
  await addMessage({ type:"user", text:q });

  // Persist guest message + meter
  if (!isLoggedIn()){
    guestHistory.push({ type:"user", text:q });
    saveGuestHistory(guestHistory);
    bumpGuestCount();
  }

  // UI: typing indicator
  const typingRow = createTypingRow();

  // Build request
  const payload = { message: q, clientId, images: imagesSnapshot };

  const headers = { "Content-Type":"application/json" };
  const tok = getAuthToken();
  if (tok) headers.Authorization = "Bearer " + tok;

  // Helpers for consistent guest bookkeeping
  const persistGuestBot = (msg)=>{
    if (isLoggedIn()) return;
    guestHistory.push({ type:"bot", text:msg });
    saveGuestHistory(guestHistory);
    maybePromptLoginAfterSend();
  };

  const removeTyping = ()=>{
    try{ typingRow.remove(); }catch{}
  };

  try{
    const res = await fetch(API_VALKI, {
      method:"POST",
      headers,
      body: JSON.stringify(payload)
    });

    removeTyping();

    // Error response
    if (!res.ok){
      let errMsg = MSG_GENERIC_ERROR;

      // Only try json if it looks like json
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")){
        const j = await res.json().catch(()=>null);
        if (j && typeof j.error === "string") errMsg = "ksshhâ€¦ " + j.error;
      }

      await addMessage({ type:"bot", text:errMsg });
      persistGuestBot(errMsg);
      return;
    }

    // Success response
    const data = await res.json().catch(()=>null);
    const answer = (data && typeof data.reply === "string" && data.reply.trim())
      ? String(data.reply)
      : MSG_NO_RESPONSE;

    await addMessage({ type:"bot", text:answer });
    persistGuestBot(answer);
    scrollToBottomHard();

  }catch(err){
    console.error(err);
    removeTyping();

    await addMessage({ type:"bot", text:MSG_GENERIC_ERROR });
    persistGuestBot(MSG_GENERIC_ERROR);

  }finally{
    isSending = false;
    setSendingState(false);

    // Clear attachments after send (UI + state)
    attachments = [];
    showAttachTray();

    updateDeleteButtonVisibility();
    clampComposer();
    scheduleLayoutMetrics();
  }
}

/* =============================== Events ================================ */

// Login button -> auth overlay
loginOutBtn.addEventListener("click", ()=> openAuthOverlay({ hard:false }));

// Delete all -> confirm
deleteAllBtn.addEventListener("click", ()=>{
  if (!hasAnyRealMessages() || isSending) return;
  if (authOverlay.classList.contains("is-visible")) return;
  openConfirm();
});

confirmNo.addEventListener("click", closeConfirm);
confirmOverlay.addEventListener("click", (e)=>{ if (e.target === confirmOverlay) closeConfirm(); });

confirmYes.addEventListener("click", async ()=>{
  closeConfirm();
  await clearChatAll();
  updateDeleteButtonVisibility();
});

// Logout -> do logout
logoutYes.addEventListener("click", async ()=>{
  closeLogoutPrompt();
  await logout();
});

/* Bubble opens chat */
async function openFromBubble(e){
  if (e){
    e.preventDefault();
    e.stopPropagation();
  }

  markBubbleSeen();

  // Logged in: load messages then force open
  if (isLoggedIn()){
    await loadLoggedInMessagesToUI({ forceOpen:true });
    return;
  }

  // Guest: open + render local history
  openOverlay();
  await renderGuestHistoryToUI();

  if (guestHardBlocked()) openAuthOverlay({ hard:true });
}

// IMPORTANT: button already supports keyboard -> avoid double-fire bug
bubble.addEventListener("click", openFromBubble);

/* Composer submit */
chatForm.addEventListener("submit", (e)=>{
  e.preventDefault();
  const q = cleanText(chatInput.value);
  if (!q) return;

  chatInput.value = "";
  clampComposer();
  askValki(q);
});

/* Enter to send, Shift+Enter newline */
chatInput.addEventListener("keydown", (e)=>{
  if (e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    chatForm.dispatchEvent(new Event("submit", { cancelable:true, bubbles:true }));
  }
});

/* Auto-grow */
chatInput.addEventListener("input", clampComposer);
chatInput.addEventListener("paste", ()=> setTimeout(clampComposer, 0));

/* Attachments */
attachBtn.addEventListener("click", ()=>{
  if (chatInput.disabled || isSending) return;
  fileInput.click();
});

fileInput.addEventListener("change", async ()=>{
  await addFiles(fileInput.files);
  fileInput.value = "";
  clampComposer();
  scheduleLayoutMetrics();
});

// Close modal
closeBtn.addEventListener("click", closeOverlay);

/* ESC handling */
document.addEventListener("keydown", (e)=>{
  if (e.key !== "Escape") return;

  if (logoutOverlay.classList.contains("is-visible")){ closeLogoutPrompt(); return; }
  if (confirmOverlay.classList.contains("is-visible")){ closeConfirm(); return; }
  if (authOverlay.classList.contains("is-visible")){ if (!authHard) closeAuthOverlay(); return; }
  if (isChatOpen()) closeOverlay();
});

/* Account click triggers */
function attachAccountTrigger(el){
  if (!el) return;
  el.addEventListener("click", (e)=>{
    e.preventDefault();
    e.stopPropagation();
    if (isLoggedIn()) openLogoutPrompt();
    else openAuthOverlay({ hard:false });
  });
}
attachAccountTrigger(headerAvatar);
attachAccountTrigger(headerTitle);
attachAccountTrigger(sessionLabel);

/* Auth overlay clicks */
loginDiscordBtn.addEventListener("click", openDiscordLoginPopup);
loginGoogleBtn.addEventListener("click", openGoogleLoginPopup);
joinDiscordBtn.addEventListener("click", ()=> window.open(DISCORD_INVITE_URL, "_blank", "noopener,noreferrer"));

authDismiss.addEventListener("click", closeAuthOverlay);
authOverlay.addEventListener("click", (e)=>{ if (e.target === authOverlay) closeAuthOverlay(); });

/* Logout overlay clicks */
logoutNo.addEventListener("click", closeLogoutPrompt);

/* Resize / rotate / keyboard open-close */
function onViewportChange(){
  scheduleLayoutMetrics();
  scrollToBottom(false);
}

window.addEventListener("resize", onViewportChange, { passive:true });
window.addEventListener("orientationchange", ()=> setTimeout(onViewportChange, 60), { passive:true });

if (window.visualViewport){
  window.visualViewport.addEventListener("resize", ()=>{
    updateComposerH();
    scrollToBottom(false);
  });
}

if (document.fonts && document.fonts.ready){
  document.fonts.ready.then(()=>{
    if (document.activeElement === chatInput) clampComposer();
    scheduleLayoutMetrics();
  }).catch(()=>{});
}

/* =============================== Boot ================================ */
(async function boot(){
  await fetchMe();
  updateSessionLabel();
  updateLoginOutButtonLabel();
  setAttachmentUiDisabled(false);

  if (shouldShowBubbleBadge()) showBubbleBadge("1");

  if (isLoggedIn()){
    await loadLoggedInMessagesToUI({ forceOpen:false });
  } else {
    guestHistory = loadGuestHistory();
    await renderGuestHistoryToUI();
  }

  updateDeleteButtonVisibility();

  updateLayoutMetrics();
  clampComposer();
  updateLayoutMetrics();
})();
})();
</script>
